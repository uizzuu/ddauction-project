import os
from langchain_openai import ChatOpenAI
from langchain_core.prompts import ChatPromptTemplate
from dotenv import load_dotenv

# í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
load_dotenv()


class ProductDescriptionGenerator:
    def __init__(self):
        # ìƒí’ˆ ì„¤ëª… ìƒì„±ì€ ì°½ì˜ì„±ì´ í•„ìš”í•˜ë¯€ë¡œ temperatureë¥¼ ì•½ê°„ ë†’ê²Œ(0.7) ì„¤ì •
        self.llm = ChatOpenAI(
            model="gpt-4o-mini",
            temperature=0.7
        )

        # í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ ì •ì˜
        # ì—­í•  ë¶€ì—¬ -> ì…ë ¥ ë°ì´í„° ëª…ì‹œ -> ì¶œë ¥ í˜•ì‹ ì§€ì •
        # product_generator.py ìˆ˜ì •
        self.prompt = ChatPromptTemplate.from_messages([
            ("system", "ë‹¹ì‹ ì€ 10ë…„ ê²½ë ¥ì˜ ì´ì»¤ë¨¸ìŠ¤ ì „ë¬¸ ì¹´í”¼ë¼ì´í„°ì…ë‹ˆë‹¤."),
            ("human", """
            ë‹¤ìŒ ìƒí’ˆ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ìƒì„¸ í˜ì´ì§€ì— ë“¤ì–´ê°ˆ ìƒí’ˆ ì„¤ëª…ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.

            [ìƒí’ˆ ì •ë³´]
            1. ìƒí’ˆëª…: {product_name}
            2. ì£¼ìš” íŠ¹ì§•/í‚¤ì›Œë“œ: {keywords}
            3. íƒ€ê²Ÿ ê³ ê°: {target_audience}
            4. ì›í•˜ëŠ” ë¶„ìœ„ê¸°(í†¤ì•¤ë§¤ë„ˆ): {tone}

            âš ï¸ í‚¤ì›Œë“œê°€ ë¹„ì–´ìˆë‹¤ë©´, ìƒí’ˆëª…ì„ ë¶„ì„í•´ì„œ ì ì ˆí•œ í‚¤ì›Œë“œë¥¼ ìë™ìœ¼ë¡œ ì¶”ë¡ í•˜ì„¸ìš”.
            âš ï¸ íƒ€ê²Ÿ ê³ ê°ì´ "ì¼ë°˜ ê³ ê°"ì´ë¼ë©´, ìƒí’ˆëª…ì„ ë³´ê³  ê°€ì¥ ì í•©í•œ íƒ€ê²Ÿì„ ì¶”ë¡ í•˜ì„¸ìš”.

            [ì‘ì„± ê°€ì´ë“œ]
            - ëˆˆê¸¸ì„ ì‚¬ë¡œì¡ëŠ” í•œ ë¬¸ì¥ ì¹´í”¼ (ì¹œê·¼í•˜ê²Œ, êµ¬ë§¤ ìš•êµ¬ ìê·¹)
              ì˜ˆ: "ê±°ì˜ ìƒˆê±°ì—ìš”. ì´ë²ˆ ì£¼ë§Œ íŠ¹ê°€ë¡œ íŒë§¤í•©ë‹ˆë‹¤"
            - ì œí’ˆ ìƒíƒœ, ì‚¬ìš©ê°, ì¥ì  ë“± ê°„ë‹¨íˆ ì„œìˆ  (2~3ë¬¸ì¥)
              ì˜ˆ: "ì‚¬ìš©ê° ê±°ì˜ ì—†ê³ , ìŠ¤í¬ë˜ì¹˜ ì „í˜€ ì—†ëŠ” ê¹¨ë—í•œ ìƒíƒœì˜ˆìš”. ì›í•˜ì‹œë©´ ì‚¬ì§„ ë” ë³´ë‚´ë“œë ¤ìš”!"
            - ê°€ê²©, í• ì¸, êµ¬ì„±í’ˆ ë“± ê°•ì¡°
              ì˜ˆ: "ì •ê°€ 5ë§Œì› â†’ 3ë§Œì›ì— ê¸‰ì²˜! êµ¬ì„±í’ˆ ì „ë¶€ í¬í•¨"
            - ë°°ì†¡/ê±°ë˜ ë°©ì‹ ì•ˆë‚´
              ì˜ˆ: "ì§ê±°ë˜ëŠ” ì„œìš¸ ê°•ë‚¨/ì ì‹¤ ê°€ëŠ¥, íƒë°°ëŠ” ë°˜íƒë§Œ ê°€ëŠ¥í•´ìš”."
            - ë§ˆë¬´ë¦¬ ë©˜íŠ¸, ì¹œê·¼í•˜ê²Œ
              ì˜ˆ: "ê´€ì‹¬ ìˆìœ¼ì‹  ë¶„ì€ DM ì£¼ì„¸ìš” ğŸ˜Š"

            ê²°ê³¼ëŠ” ë§ˆí¬ë‹¤ìš´ í˜•ì‹ì´ ì•„ë‹Œ ì¼ë°˜ í…ìŠ¤íŠ¸ë¡œ ê°€ë…ì„± ìˆê²Œ ì‘ì„±í•´ì£¼ì„¸ìš”.
            """)
        ])

        # ì²´ì¸ ìƒì„± (Prompt -> LLM)
        self.chain = self.prompt | self.llm

    def generate(self, product_name: str, keywords: list, target_audience: str, tone: str = "ì¹œê·¼í•œ"):
        """
        ìƒí’ˆ ì •ë³´ë¥¼ ë°›ì•„ ì„¤ëª…ì„ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
        """
        try:
            # í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸ë¥¼ ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ë¬¸ìì—´ë¡œ ë³€í™˜
            keywords_str = ", ".join(keywords)

            response = self.chain.invoke({
                "product_name": product_name,
                "keywords": keywords_str,
                "target_audience": target_audience,
                "tone": tone
            })
            return response.content
        except Exception as e:
            print(f"âŒ ìƒí’ˆ ì„¤ëª… ìƒì„± ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            return "ì£„ì†¡í•©ë‹ˆë‹¤. ìƒí’ˆ ì„¤ëª…ì„ ìƒì„±í•˜ëŠ” ë„ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."


# ì™¸ë¶€(api.py)ì—ì„œ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì¸ìŠ¤í„´ìŠ¤ ìƒì„±
generator_service = ProductDescriptionGenerator()